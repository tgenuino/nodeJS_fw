var     bundler         = require('bundler'),
        fs              = require('fs')
        path            = require('path');

var _init = function(app, req, res) {
    var me = this;
    
    me.app = app;
    me.req = req;
    me.res = res;
    
    var params = req.params[0].replace(__modpath.replace(__base, '').replace(/[\/\\]/g, '/'), '').split('/').slice(1);
    
    var met = params[0];
    
    if (typeof me[met] == 'function')
        me[met](params.slice(1));
};

var loader = function(route, app, req, res) {
    var __params = [app, req, res];
    
//    console.log('ROUTER: Testing [ ' + route + ' ]');
    fs.stat(route, function(err, st) {
        if (!err) {
            if (st.isDirectory()) {
                fs.exists(route + '/index.js', function(exist) {
                    if (exist) {
                        global.__modpath = path.resolve(route);
                        var call = require(path.resolve(route));
                        call._init = _init;
                        call._init(app, req, res);
                    } else {
                        fs.exists(route + '/config.js', function(exist) {
                            if (exist) {
                                global.__modpath = path.resolve(route);
                                var call = bundler(route)
                                call._init = _init;
                                call._init(app, req, res);
                            } else {
                                route = path.dirname(route);
                                if (route != '.')
                                    loader(route, app, req, res);
                                else {
//                                    console.log('ROUTER: System not found');
                                    res.send(404);
                                }
                            }
                        });
                    }
                });
            } else {
                route = path.dirname(route);
                loader(route, app, req, res);
            }
        } else {
            route = path.dirname(route);
            loader(route, app, req, res);
        }
    });
};

module.exports = function(app, req, res) {
    var route = '.' + req.params[0];

    loader(route, app, req, res);
};